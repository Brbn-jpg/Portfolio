---
import Layout from '../layouts/layout.astro';
import GlitchText from '../components/glitchText.jsx';
import TerminalBlock from '../components/terminalBlock.astro';
import ContactForm from '../components/ContactForm.jsx';
import StatCard from '../components/statCard.astro';
import ProjectCard from '../components/projectCard.astro';
import { allProjects } from '../data/projects';
import { Cpu, Bike, Dumbbell, Github, Code, Activity, Wifi, Server, Layers, Brain, ArrowRight } from 'lucide-react';

const languages = [
  { name: "Java", level: 90 },
  { name: "TypeScript / JS", level: 85 },
  { name: "Python", level: 75 },
  { name: "C#", level: 55 },
];

const technologies = [
  "Spring Boot", "LangChain4j", "LangChain", "PostgreSQL", 
  "Docker", "Git", "Angular", "Vue", "Astro", "RAG Systems", "LLM Integration"
];

---

<Layout title="Brbn-jpg | Backend & AI Dev">
  <main class="relative z-10 max-w-5xl mx-auto px-6 py-12 md:py-20">
    
    {/* HEADER */}
    <header class="text-center mb-20">
      <div class="inline-block mb-4 px-3 py-1 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-xs font-mono animate-pulse">
        SYSTEM STATUS: READY TO DEPLOY
      </div>
      <h1 class="text-5xl md:text-7xl font-black text-slate-100 mb-6 tracking-tight">
        HELLO, I'M <GlitchText client:visible text="BRBN-JPG" />
      </h1>
      <p class="text-xl text-slate-400 max-w-3xl mx-auto mb-8 leading-relaxed">
        My name is Jakub Ku≈∫nicki and I am an IT student. As a Backend Developer & AI Integrator, 
        I specialize in <span class="text-green-400 font-bold">Java, Python</span> and <span class="text-green-400 font-bold">RAG / LLM</span> system architecture. 
        I enjoy building scalable applications and exploring hardware innovations.
      </p>

      <div class="mb-8 text-center">
        <a href="/about" class="inline-flex items-center gap-2 text-green-400 font-mono text-sm hover:text-green-300 transition-colors group">
          More about me <ArrowRight size={16} className="transition-transform group-hover:translate-x-1" />
        </a>
      </div>
      
      <div class="flex justify-center gap-4 mb-12">
        <a href="https://github.com/Brbn-jpg" target="_blank" rel="noreferrer" 
           class="flex items-center gap-2 bg-slate-100 text-slate-900 px-6 py-3 font-bold hover:bg-green-400 transition-colors rounded-sm">
          <Github size={20} />
          GITHUB PROFILE           <span class="sr-only">GitHub Profile</span>

        </a>
        <ContactForm client:load formspreeId="xgvddwnz" />
      </div>

      <TerminalBlock />
    </header>

    {/* STATS GRID */}
    <section class="mb-24">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard label="Hardware" value="Tech Enthusiast" subtext="PC Building & Innovations" color="text-blue-400">
          <Cpu slot="icon" size={24} client:visible />
        </StatCard>
        <StatCard label="Focus" value="RAG & LLM" subtext="LangChain & AI Systems" color="text-purple-400">
          <Brain slot="icon" size={24} client:visible />
        </StatCard>
        <StatCard label="Cardio" value="Cycling" subtext="Gravel & Road adventures" color="text-orange-400">
          <Bike slot="icon" size={24} client:visible />
        </StatCard>
        <StatCard label="Strength" value="Gym / Lift" subtext="Training & Discipline" color="text-red-400">
          <Dumbbell slot="icon" size={24} client:visible />
        </StatCard>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
      
      {/* LEFT COLUMN */}
      <div class="lg:col-span-1 space-y-12">
        
        {/* Languages */} 
        <div>
          <div class="flex items-center gap-3 mb-8 border-b border-slate-800 pb-2">
            <Code className="text-green-500" size={24} />
            <h2 class="text-2xl font-bold text-slate-100 font-mono tracking-tight">CORE_LANGS</h2>
          </div>
          <div class="space-y-4">
            {languages.map(lang => (
              <div>
                <div class="flex justify-between text-sm font-mono text-slate-400 mb-1">
                  <span>{lang.name}</span>
                  <span>{lang.level}%</span>
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div class="h-full bg-green-600" style={`width: ${lang.level}%`}></div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Technologies */}
        <div>
          <h3 class="text-slate-100 font-bold mb-4 flex items-center gap-2 font-mono">
            <Layers size={18} className="text-green-400" />
            TECH_ARSENAL
          </h3>
          <div class="flex flex-wrap gap-2">
            {technologies.map(tech => (
              <span class="bg-slate-900 border border-slate-700 px-3 py-1 text-xs text-slate-300 font-mono rounded hover:border-green-500 hover:text-green-400 transition-colors cursor-default">
                {tech}
              </span>
            ))}
          </div>
        </div>

        {/* Activity */}
        <div class="bg-slate-900/50 border border-slate-800 p-6 rounded-lg">
          <h3 class="text-slate-100 font-bold mb-4 flex items-center gap-2">
            <Activity size={18} className="text-green-400" />
            Recent Activity
          </h3>
          <div id="commits-container" class="space-y-4 text-sm text-slate-400 font-mono">
            <p class="text-slate-500">Fetching latest activity...</p>
          </div>
        </div>
      </div>

      {/* RIGHT COLUMN: PROJECTS */}
      <div class="lg:col-span-2">
        <div id="repositories" class="flex items-center gap-3 mb-8 border-b border-slate-800 pb-2 scroll-mt-20">
          <Server className="text-green-500" size={24} />
          <h2 class="text-2xl font-bold text-slate-100 font-mono tracking-tight">REPOSITORIES</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {allProjects.map((project) => <ProjectCard project={project} />)}
          
          {/* Placeholder More */}
          <a href="https://github.com/Brbn-jpg" target="_blank" rel="noreferrer" class="border border-dashed border-slate-800 p-5 flex flex-col items-center justify-center text-slate-500 hover:text-slate-300 hover:border-slate-600 transition-all cursor-pointer group rounded-sm">
            <Github size={32} className="mb-2 opacity-50 group-hover:scale-110 transition-transform" />
            <span class="font-mono text-sm">Check github.com/Brbn-jpg for more</span>
          </a>
        </div>
      </div>
    </div>

    {/* FOOTER */}
    <footer class="mt-24 pt-8 border-t border-slate-800 text-center text-slate-500 text-sm font-mono flex flex-col md:flex-row justify-between items-center">
      <div class="mb-4 md:mb-0">
        &copy; {new Date().getFullYear()} Brbn-jpg.
      </div>
      <div class="flex gap-6 items-center">
        <a href="/about" class="hover:text-slate-300 transition-colors">About Me</a>
        <span class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          RAG Systems Operational
        </span>
        <span class="flex items-center gap-1">
          <Wifi size={14} />
          Warsaw, PL
        </span>
      </div>
    </footer>

  </main>
</Layout>

<script>
  function initializeGitHubActivity(container: HTMLElement) {
    const timeAgo = (dateString: string): string => {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.round((now.getTime() - date.getTime()) / 1000);
      const minutes = Math.round(seconds / 60);
      const hours = Math.round(minutes / 60);
      const days = Math.round(hours / 24);

      if (seconds < 60) return `${seconds}s ago`;
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return `${days}d ago`;
    };

    const renderCommits = (commits: any[]) => {
      if (!commits || commits.length === 0) {
        container.innerHTML = '<p class="text-slate-500">Could not fetch recent activity.</p>';
        return;
      }

      const list = document.createElement('ul');
      list.className = 'space-y-4';
      
      commits.forEach(commit => {
        const listItem = document.createElement('li');
        listItem.className = 'flex gap-3';
        listItem.innerHTML = `
          <span class="text-slate-600 flex-shrink-0 w-16 text-right">${timeAgo(commit.date)}</span>
          <a href="${commit.url}" target="_blank" rel="noopener noreferrer" class="truncate hover:text-green-400 transition-colors" title="${commit.message}">
            ${commit.message}
          </a>
        `;
        list.appendChild(listItem);
      });

      container.innerHTML = '';
      container.appendChild(list);
    };

    const getRecentCommits = async () => {
      const CACHE_KEY = 'github_commits_cache';
      const CACHE_DURATION_MINUTES = 5;

      const cachedData = sessionStorage.getItem(CACHE_KEY);
      if (cachedData) {
        const { timestamp, commits } = JSON.parse(cachedData);
        if ((new Date().getTime() - timestamp) / (1000 * 60) < CACHE_DURATION_MINUTES) {
          console.log('--- [CACHE] Loading commits from session storage ---');
          return renderCommits(commits);
        }
      }

      try {
        const reposResponse = await fetch('https://api.github.com/users/Brbn-jpg/repos?sort=pushed&direction=desc&per_page=5', {
          headers: { 'User-Agent': 'Astro-Portfolio' }
        });

        if (!reposResponse.ok) throw new Error('Failed to fetch repos');
        
        const repos = await reposResponse.json();
        const allCommits = [];

        for (const repo of repos) {
          const commitsResponse = await fetch(`https://api.github.com/repos/${repo.full_name}/commits?per_page=5`, {
            headers: { 'User-Agent': 'Astro-Portfolio' }
          });
          if (commitsResponse.ok) {
            const commits = await commitsResponse.json();
            allCommits.push(...commits.map((c: any) => ({
              repo: repo.name,
              message: c.commit.message,
              sha: c.sha.slice(0, 7),
              url: c.html_url,
              date: c.commit.committer.date
            })));
          }
        }
        const sortedCommits = allCommits.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()).slice(0, 3);
        
        sessionStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: new Date().getTime(), commits: sortedCommits }));
        renderCommits(sortedCommits);
      } catch (error) {
        console.error('Error fetching GitHub activity:', error);
        renderCommits([]);
      }
    };

    getRecentCommits();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const commitsContainer = document.getElementById('commits-container');
    if (commitsContainer) {
      initializeGitHubActivity(commitsContainer);
    }
  });
</script>
